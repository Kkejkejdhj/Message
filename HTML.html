<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangla Chat Pro - Live</title>
    <style>
        :root { --primary: #075e54; --secondary: #128c7e; --bg: #e5ddd5; --light: #dcf8c6; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #d1d7db; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        #app-wrapper { width: 100%; max-width: 500px; height: 100vh; background: white; display: flex; flex-direction: column; position: relative; }

        /* Auth Screen */
        .auth-container { padding: 40px 20px; display: flex; flex-direction: column; justify-content: center; height: 100%; text-align: center; background: #f0f2f5; }
        input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 10px; font-size: 16px; outline: none; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 17px; }

        /* Chat UI */
        #chat-screen { display: none; flex-direction: column; height: 100%; background: var(--bg); }
        header { background: var(--primary); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .add-friend-btn { background: #ffffff33; color: white; border: 1px solid white; padding: 5px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; }
        .action-btns button { background: none; border: none; color: white; font-size: 22px; cursor: pointer; margin-left: 12px; }

        /* Message Area */
        #msg-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; font-size: 15px; word-wrap: break-word; position: relative; display: flex; flex-direction: column; }
        .me { background: var(--light); align-self: flex-end; border-bottom-right-radius: 0; }
        .friend { background: white; align-self: flex-start; border-bottom-left-radius: 0; }
        
        .msg-time { font-size: 9px; color: #666; margin-top: 4px; align-self: flex-end; }
        .call-log { background: #fff3cd !important; align-self: center !important; border-radius: 15px !important; font-size: 12px !important; color: #856404; border: 1px solid #ffeeba; text-align: center; }

        /* Call Overlay */
        #call-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: #0b141a; color: white; display: none; flex-direction: column; align-items: center; justify-content: space-around; z-index: 10000; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #localVideo { width: 100px; height: 140px; object-fit: cover; position: absolute; top: 20px; right: 20px; border: 2px solid white; border-radius: 10px; z-index: 11; background: #000; }
        .call-info { z-index: 12; text-align: center; }
        .call-btns { display: flex; gap: 40px; z-index: 12; }
        .c-btn { width: 70px; height: 70px; border-radius: 50%; border: none; cursor: pointer; font-size: 30px; color: white; display: flex; align-items: center; justify-content: center; }
        .ans-btn { background: #25d366; }
        .rej-btn { background: #ff3b30; }

        /* Emoji Panel */
        #emoji-panel { display: none; background: white; border-top: 1px solid #ccc; height: 250px; overflow-y: auto; padding: 10px; grid-template-columns: repeat(7, 1fr); gap: 5px; font-size: 26px; }
        .emoji-item { cursor: pointer; text-align: center; padding: 5px; }

        /* Input Bar */
        .input-bar { display: flex; padding: 10px; background: #f0f0f0; gap: 10px; align-items: center; }
        #msgInput { flex: 1; border-radius: 20px; padding: 10px 15px; border: none; outline: none; }
        .emoji-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

<div id="app-wrapper">
    <div id="call-overlay">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        <div class="call-info">
            <h2 id="call-status">‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</h2>
            <h1 id="call-name">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</h1>
        </div>
        <div class="call-btns">
            <button class="c-btn ans-btn" id="acceptBtn" onclick="answerCall()">üìû</button>
            <button class="c-btn rej-btn" onclick="endCall()">‚úñ</button>
        </div>
    </div>

    <div id="auth-screen" class="auth-container">
        <h1>Bangla Chat Pro üí¨</h1>
        <input type="tel" id="myNo" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®">
        <input type="tel" id="frNo" placeholder="‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®">
        <button class="btn-main" onclick="initApp()">‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div id="chat-screen">
        <header>
            <div style="display: flex; flex-direction: column; gap: 4px;">
                <strong>üë§ <span id="headerName">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</span></strong>
                <button class="add-friend-btn" onclick="addNewFriendChat()">‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
            <div class="action-btns">
                <button onclick="startCall('audio')">üìû</button>
                <button onclick="startCall('video')">üìπ</button>
            </div>
        </header>

        <div id="msg-area"></div>
        <div id="emoji-panel"></div>

        <div class="input-bar">
            <button class="emoji-btn" onclick="toggleEmoji()">üòä</button>
            <input type="text" id="msgInput" placeholder="‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." onkeypress="if(event.key==='Enter') sendText()">
            <button onclick="sendText()" style="border:none; background:var(--secondary); color:white; width:40px; height:40px; border-radius:50%; cursor: pointer;">‚û§</button>
        </div>
    </div>
</div>

<audio id="ringtone" loop src="https://www.soundjay.com/phone/telephone-ring-03a.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
    const firebaseConfig = {
        apiKey: "AIzaSyCFPK1Vb-X0zidd5Hq6mOf5RQ3WUAtPhRg", // New API Key from JSON
        databaseURL: "https://user-3f723-default-rtdb.firebaseio.com", // New DB URL from JSON
        projectId: "user-3f723", // New Project ID from JSON
        storageBucket: "user-3f723.firebasestorage.app" // New Storage Bucket from JSON
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myPhone, friendPhone, chatRoom, localStream, peerConnection;
    const rtcConfig = { iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }] };
    const ringtone = document.getElementById('ringtone');

    // Emoji functions
    function loadEmojis() {
        const panel = document.getElementById('emoji-panel');
        let emojiHTML = '';
        const ranges = [[0x1F600, 0x1F64F], [0x1F680, 0x1F6C5], [0x1F300, 0x1F5FF]];
        ranges.forEach(range => {
            for (let i = range[0]; i <= range[1]; i++) {
                emojiHTML += `<span class="emoji-item" onclick="addEmoji('${String.fromCodePoint(i)}')">${String.fromCodePoint(i)}</span>`;
            }
        });
        panel.innerHTML = emojiHTML;
    }

    function toggleEmoji() {
        const panel = document.getElementById('emoji-panel');
        panel.style.display = panel.style.display === 'grid' ? 'none' : 'grid';
    }

    function addEmoji(emoji) { document.getElementById('msgInput').value += emoji; }

    // Init and Auth
    function initApp() {
        myPhone = document.getElementById('myNo').value.trim();
        friendPhone = document.getElementById('frNo').value.trim();
        if (myPhone && friendPhone) { loadEmojis(); startChat(); } else alert("‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®!");
    }

    function addNewFriendChat() {
        const newNum = prompt("‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®:");
        if (newNum) { friendPhone = newNum.trim(); startChat(); }
    }

    function formatTime(timestamp) {
        if(!timestamp) return "";
        const date = new Date(timestamp);
        return date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Chat logic
    function startChat() {
        chatRoom = [myPhone, friendPhone].sort().join('_');
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'flex';
        document.getElementById('headerName').innerText = friendPhone;
        document.getElementById('msg-area').innerHTML = "";
        
        db.ref('chats/' + chatRoom).off();
        db.ref('chats/' + chatRoom).on('child_added', snap => {
            const data = snap.val();
            const div = document.createElement('div');
            div.className = 'msg ' + (data.type === 'call' ? 'call-log' : (data.sender === myPhone ? 'me' : 'friend'));
            div.innerHTML = `<span>${data.content}</span><span class="msg-time">${formatTime(data.timestamp)}</span>`;
            document.getElementById('msg-area').appendChild(div);
            document.getElementById('msg-area').scrollTop = document.getElementById('msg-area').scrollHeight;
        });
        listenForSignals();
    }

    function sendText() {
        const text = document.getElementById('msgInput').value.trim();
        if(text) {
            db.ref('chats/' + chatRoom).push({ 
                sender: myPhone, 
                content: text, 
                type: 'text',
                timestamp: Date.now() 
            });
            document.getElementById('msgInput').value = "";
            document.getElementById('emoji-panel').style.display = 'none';
        }
    }

    // Call logic (Audio/Video)
    async function startCall(type) {
        openCallUI('‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...', friendPhone, false, type);
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: type === 'video' });
        if(type === 'video') document.getElementById('localVideo').srcObject = localStream;
        
        peerConnection = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        
        peerConnection.onicecandidate = e => { if (e.candidate) db.ref(`signals/${friendPhone}/candidates`).push(JSON.stringify(e.candidate)); };
        peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
        
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        db.ref(`signals/${friendPhone}`).set({ offer: JSON.stringify(offer), caller: myPhone, type: type, status: 'ringing' });
        
        db.ref(`signals/${friendPhone}/answer`).on('value', async snap => {
            const answer = snap.val();
            if (answer && peerConnection.signalingState !== "stable") {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
                document.getElementById('call-status').innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá";
            }
        });
    }

    function listenForSignals() {
        db.ref(`signals/${myPhone}`).on('value', async snap => {
            const data = snap.val();
            if (data && data.status === 'ringing') {
                openCallUI('‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡¶ø‡¶Ç ' + data.type + ' ‡¶ï‡¶≤...', data.caller, true, data.type);
                ringtone.play().catch(() => {});
            } else if (!data && peerConnection) {
                closeCallUI();
            }
        });
        db.ref(`signals/${myPhone}/candidates`).on('child_added', snap => {
            if (peerConnection && snap.val()) peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(snap.val())));
        });
    }

    async function answerCall() {
        ringtone.pause();
        const snap = await db.ref(`signals/${myPhone}`).once('value');
        const data = snap.val();
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: data.type === 'video' });
        if(data.type === 'video') document.getElementById('localVideo').srcObject = localStream;
        
        peerConnection = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
        
        await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.offer)));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        db.ref(`signals/${myPhone}/answer`).set(JSON.stringify(answer));
        document.getElementById('call-status').innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá";
        document.getElementById('acceptBtn').style.display = 'none';
    }

    function openCallUI(status, name, showAccept, type) {
        document.getElementById('call-overlay').style.display = 'flex';
        document.getElementById('call-status').innerText = status;
        document.getElementById('call-name').innerText = name;
        document.getElementById('acceptBtn').style.display = showAccept ? 'flex' : 'none';
        document.getElementById('localVideo').style.display = (type === 'video') ? 'block' : 'none';
    }

    function endCall() {
        ringtone.pause();
        db.ref(`signals/${myPhone}`).remove();
        db.ref(`signals/${friendPhone}`).remove();
        if (localStream) localStream.getTracks().forEach(t => t.stop());
        if (peerConnection) peerConnection.close();
        closeCallUI();
    }

    function closeCallUI() {
        document.getElementById('call-overlay').style.display = 'none';
        document.getElementById('remoteVideo').srcObject = null;
        peerConnection = null;
    }
</script>
</body>
</html>
